---
title: "London vehicle travel time STDM: preparation and EDA"
author: "Mark Ruddy"
date: "24 March 2015"
output: html_document
---

# Description

Data preparation and EDA for space-time aurocorrelation analysis of network data for London motor vehicle travel time analysis.


#Package imports
```{r}
library(gdata) # for xls import
library(ggplot2)
library(dplyr)
library(tidyr)
library(zoo)
library(xts)
# library(lubridate)
library(chron)
```

# Space-time autocorrelation analysis

## Road network data

Network aggregate motor vehicle travel times in seconds per metre from 22 road links.

Data taken between Monday 24th May 2010 and Friday 5th November 2010 (23 weeks and five days).

The motor vehicle travel time data comes as a directed network.

Spatial weights matrices for the travel data are a binary scheme row standardised. Standardisation is done to equally allocate the contribution of neighbouring nodes to the node of interest ([@cheng2012spatio p396] for details).

## Data preparation

Read in network aggregate travel time data (unit journey time - ujt). 
```{r}
ujt <- read.csv("./data/ujt.csv")
```

Read in spatial weights. Need to open .xls file and copy/paste weight matrices into separate worksheets, then refer to individual worksheets during read.xls()
Get weights from .xls file and write each to a new .csv
```{r}
# w1 <- read.xls(xls = "./data/Weight_Matrices.xls", sheet="w1",header =T)
# write.csv(w1, "./data/weights1.csv", row.names=F)
# w2 <- read.xls(xls = "./data/Weight_Matrices.xls", sheet="w2",header =T)
# write.csv(w2, "./data/weights2.csv", row.names=F)
# w3 <- read.xls(xls = "./data/Weight_Matrices.xls", sheet="w3",header =T)
# write.csv(w3, "./data/weights3.csv", row.names=F)
```

```{r}
w1 <- read.csv("./data/weights1.csv")
w2 <- read.csv("./data/weights2.csv")
w3 <- read.csv("./data/weights3.csv")
```


## Make date-time series for ujt time series observations
Now we need to add the dates and times that each observation was made. This is most effectively done using a format that is intended for time-series analysis such as xts (extended time series).
Useful links > http://stackoverflow.com/questions/28587939/create-vector-of-non-weekend-time-intervals-for-part-of-a-day-in-r/28590233#28590233

Create data and times
```{r}
# create time intervals for one day - 6:00 to 21:00
intervals <- as.character(times(72:252/288))

# create list of dates where observations were made - Monday 24th May 2010 and Friday 5th November 2010 (23 weeks and five days)
dayseq <- timeBasedSeq("2010-05-24/2010-11-04/d")

# concatenate date and times then format to POSIXct
obstime<-strptime(unlist(lapply(dayseq,function(x){paste(x,intervals)})),format="%Y-%m-%d %H:%M", tz="GMT")

# clean up
rm(dayseq)
```

## Make unit journey time data into a time series object using xts
We can produce a time series object here to make selection of individual days possible.

Create time series xts object from ujt observations and date-time POSIXct
```{r}
ujt.ts <- xts(ujt,obstime)

# look at variables
# head(coredata(ujt.ts))

# look at date/time portion 
# head(index(ujt.ts))

# clean up
rm(obstime)
```

## Plotting

We want to plot averages of time series from just one day. The xts object is not suitable for plotting these data in ggplot2. Solution: add dates and times as factors to the ujt data.frame.

Add dates to ujt.ts with dates and times as factors.
```{r}
# take date from ujt.ts xts object
dates <- as.Date(index(ujt.ts), format="%d-%b-%Y")
# combine with date as factor
ujt.date <- cbind(as.factor(dates),ujt)
colnames(ujt.date)[1] <- "date"
```

Add decimal time to ujt
```{r}
# add decimal times for plotting
# ref http://stackoverflow.com/questions/5186972/how-to-convert-time-mmss-to-decimal-form-in-r
intervals.dec <- sapply(strsplit(intervals,":"),
                      function(x) {
                        x <- as.numeric(x)
                        x[1]+x[2]/60
                      })

# for decimal times repeat intervals for every day in time series
intervals.rep <- rep(intervals.dec,166)
# head(intervals.rep,190)

# combine with time as factor
ujt.dt <- cbind(intervals.rep,ujt.date)
colnames(ujt.dt)[1] <- "time"
# head(ujt.dt)

# clean up
rm(obstime, intervals, intervals.rep, dates, ujt.date, intervals.dec, dayseq)
```

## Picking weekdays

Tuesday, Wednesdays or Thursdays are assumed to be generally representative of traffic flows. Aim: to extract time series only for midweek days and plot for specific links to determine whether all midweek days are comparable and to contrast with Mondays, Fridays and Weekends.

### Plot Tuesdays 

For a selection of links (X425, X2140, X432, X1419) or X1616, X463, X1593, X2324 which correspond with Cheng et al 2011.
1. Filter day
2. Group by time
3. Find means for links
```{r}
ujt.tues <- ujt.dt %>%
  group_by(time) %>%
  filter(weekdays(as.Date(date)) %in% "Tuesday") %>%
  summarise_each(funs(mean)) %>%
  select(time, X1616, X463, X1593, X2324)
# checked for number of inputs to each mean by using summarise_each(func(mean,n())

# gather data for plotting
ujt.tues.g <- ujt.tues %>% gather(link, ujt_mean, -time)

# plot mean speed for 
# 1 metre/second = 2.23694 miles per hour ref google (1/ujt_mean*2.23694)
ggplot(ujt.tues.g, aes(x=time, y=1/ujt_mean*2.23694, colour=link, group=link)) + 
  scale_x_continuous(limits=c(6,21), breaks=6:21) +
  scale_y_continuous(limits=c(0,15)) +
  labs(title="Variation in mean traffic speed for Tuesdays", x="Time of day (hour)", y="Mean journey speed (miles/hour)") +
  geom_line()

rm(ujt.tues.g, ujt.tues)
```

### Plot Tuesdays, Wednesdays, and Thursdays 
To compare traffic flows between midweek days.

For links c("X1616", "X2085", "X432", "X1419") in 4 different facets across . 
```{r}
# add weekdays and get means for each time to give ujt df for links we're interested in
ujt.wkd <- ujt.dt %>%
  mutate(day = weekdays(as.Date(date))) %>%
  group_by(time, day) %>%
  summarise_each(funs(mean)) %>%
  select(time, day, X425, X2085, X432, X1419, X463, X1593)

# tidy data
ujt.wkd.g <- ujt.wkd %>% gather(link, mean, -time:-day)

p <- ggplot(ujt.wkd.g, aes(x=time, y=mean, colour=day))

p + geom_line() + 
  facet_wrap(~ link, nrow=3, scales="free_y") +
  scale_x_continuous(limits=c(6,21), breaks=6:21) +
  #scale_y_continuous(limits=c(0.05,0.35)) +
  labs(title="Average unit journey time profiles", x="Time of day (hour)", y="Mean unit journey time (seconds/metre)")

rm(ujt.wkd, ujt.wkd.g)
```





