---
title: "STDM - exploratory autocorrelation analysis"
author: "Mark Ruddy"
date: "24 March 2015"
output: html_document
---

# Exploratory autocorrelation analysis

STDM coursework - appropriate ST-ACF and ST-PACF

## Imports
### Packages and functions.
```{r}
library(gdata) # for xls import
library(ggplot2)
library(dplyr)
library(tidyr)
library(zoo)
library(xts)
library(chron)

source("./functions/starima_package.R") # STARIMA functions from UCL
```

### Data

Spatial weights and unit journey time datasets.

```{r}
load("./data/STDM_base.RData")
```


## ST-ACF: Space-time autocorrelation function

Investigate spatio-temporal correlation at spatial orders 1,2 and 3. This uses weights matrices w1, w2 and w3.

We need to: 
1. Investigate patterns in the space-time data.
  * use ST-ACF at spatial orders 1,2 and 3
2. Describe patterns found.
3. Present them as plots.

Autocorrelation structures can be investigated for single days across the whole day and for time-periods within the day too. The AM peak (7:00 to 10:00), Interpeak (10:00 to 16:00), and PM peak (16:00 to 19:00).

The observations and weights matrices need to be as matrix format for the UCL STARIMA functions.

### Outliers 

How much, if any, effect does their removal have on ST analyses? We can test this through EDA on original dataset and dataset with outliers removed.

### For Wednesday AM
```{r Data prep}
# w1 weights as matrix, also removing 1st column to make symmetrical matrix
w1.m <- as.matrix(w1[,-1])
w2.m <- as.matrix(w2[,-1])
w3.m <- as.matrix(w3[,-1])

# ujt from wednesdays for original data
u.w.am <- u.w %>%
  filter(dtime<10) %>%
  select(-dtime:-date)

u.w.am <- as.matrix(u.w.am)

# ujt from Wednesday AMP for outlier corrected
u.w.rep.am <- u.w.rep %>%
  filter(dtime<10)

u.w.rep.am <- u.w.rep.am %>% 
  spread(link, ujt) %>%
  arrange(date, dtime) %>%
  select(-dtime:-date)

# needs to be numeric matrix 
u.w.rep.am <- as.matrix(sapply(u.w.rep.am, as.numeric))
```

```{r stacf analyses}
# ACF analysis
# for uncorrected data
stacf(u.w.am, w1.m, 150)
# Lag at 48 with correlation of 0.410965214
# CI = 0.01347053
stacf(u.w.am, w2.m, 150)
# Lag at 48 , corr=0.39657075
# CI = 0.01347053

stacf(u.w.am, w3.m, 150)
# Lag at 48 0.357625112
# CI= 0.01347053


# for corrected data
stacf(u.w.rep.am, w1.m, 150)
# Lag at 48 with correlation of 0.467680378
# CI = 0.01347053

stacf(u.w.rep.am, w2.m, 150)
# Lag at 48 corr=0.433060499
# CI=0.01347053


stacf(u.w.rep.am, w3.m, 150)
# Lag at 48 corr=0.387099880
# CI=0.01347053

```


```{r stpacf}

# Differencing using lag of 48
ujt.wed.am.diff <- diff(ujt.wed.am, lag=48, differences=1)
# this gives a differenced dataset where hisotic links have unit journey times of zero

# Try stacf usig differenced ujt data
stacf(ujt.wed.am.diff, w1.m, 100)
# because historic links in ujt.wed.am.diff are zero the covariances cannot be computed

# Modified stacf() - no plotting
#st.acf <- stacf2(ujt.wed.am.diff, w1.m, 100)

# partial acf on differenced ujt data
stpacf(ujt.wed.am.diff, w1.m, 10)

```
















